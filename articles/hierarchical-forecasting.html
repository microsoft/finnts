<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hierarchical Forecasting • finnts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Forecasting">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-6X0DS5856B"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6X0DS5856B');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">finnts</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0.9011</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/finnts.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ai-agent.html">AI Agent Capabilities</a>
    </li>
    <li>
      <a href="../articles/back-testing-and-hyperparameter-tuning.html">Back Testing and Hyperparameter Tuning</a>
    </li>
    <li>
      <a href="../articles/best-model-selection.html">Best Model Selection</a>
    </li>
    <li>
      <a href="../articles/external-regressors.html">External Regressors</a>
    </li>
    <li>
      <a href="../articles/feature-engineering.html">Feature Engineering</a>
    </li>
    <li>
      <a href="../articles/feature-selection.html">Feature Selection</a>
    </li>
    <li>
      <a href="../articles/forecast-components.html">Using Individual finnts Forecast Components</a>
    </li>
    <li>
      <a href="../articles/forecasting-genai.html">Forecasting with GenAI: TimeGPT in finnts</a>
    </li>
    <li>
      <a href="../articles/hierarchical-forecasting.html">Hierarchical Forecasting</a>
    </li>
    <li>
      <a href="../articles/models-used-in-finnts.html">Models Used in finnts</a>
    </li>
    <li>
      <a href="../articles/parallel-processing.html">Parallel Processing</a>
    </li>
    <li>
      <a href="../articles/tips-for-production.html">Tips for Production</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/microsoft/finnts/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hierarchical Forecasting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/microsoft/finnts/blob/main/vignettes/hierarchical-forecasting.Rmd" class="external-link"><code>vignettes/hierarchical-forecasting.Rmd</code></a></small>
      <div class="hidden name"><code>hierarchical-forecasting.Rmd</code></div>

    </div>

    
    
<p>The finnts package leverages the great work of the <a href="https://pkg.earo.me/hts/" class="external-link">hts</a> package. It’s currently retired
but we think old dogs can still learn new tricks! It’s still of great
use to finnts and allows for both standard and grouped hierarchical
forecasting.</p>
<div class="section level3">
<h3 id="standard-hierarchy">Standard Hierarchy<a class="anchor" aria-label="anchor" href="#standard-hierarchy"></a>
</h3>
<p>A standard hierarchy of data is pretty straight forward. Each combo
variable can be aggregated into the next combo variable when producing
forecasts at higher aggregations of the data. This structure resembles a
pyramid, with the bottom being the lowest granularity of time series and
the top being a single time series of the grand total of the data. Below
is a good example with geographical combo variables that can be
aggregated into one another when building a standard hierarchy
forecast.</p>
<pre><code><span><span class="co">#&gt; Standard Hierarchical Time Series Data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 5</span></span></span>
<span><span class="co">#&gt;   Continent     Country       City        Date       Target</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> North America United States Kansas City 2020-01-01    100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> North America United States Kansas City 2020-02-01    250</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> North America United States Kansas City 2020-03-01    320</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> North America United States Seattle     2020-01-01     80</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> North America United States Seattle     2020-02-01    200</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> North America United States Seattle     2020-03-01    270</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> North America Mexico        Mexico City 2020-01-01     50</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> North America Mexico        Mexico City 2020-02-01     80</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> North America Mexico        Mexico City 2020-03-01    120</span></span></code></pre>
<p>In the above example, “City” was the lowest level of the hierarchy,
which feeds into “Country”, which then feeds into “Continent”. Finn will
take this data and will forecast by City, total Country, and total
Continent. After each model is ran for every level in the hierarchy, the
best model is chosen at each level, then the “Best Model” and every
other model is reconciled back down to the lowest level.</p>
</div>
<div class="section level3">
<h3 id="grouped-hierarchy">Grouped Hierarchy<a class="anchor" aria-label="anchor" href="#grouped-hierarchy"></a>
</h3>
<p>Grouped hierarchies are very different than the traditional hierarchy
approach described above. There are some data sets that can be
aggregated in various ways, meaning they need to follow another approach
the hts package calls “grouped”. A good example is a data set that
contains historical time series by geography, customer segment, and
product.</p>
<pre><code><span><span class="co">#&gt; Grouped Hierarchical Time Series Data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 5</span></span></span>
<span><span class="co">#&gt;    Country       Segment       Product Date       Target</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> United States Enterprise    Coffee  2020-01-01     10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> United States Enterprise    Coffee  2020-02-01     20</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> United States Enterprise    Coffee  2020-03-01     30</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> United States Public Sector Coffee  2020-01-01      5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> United States Public Sector Coffee  2020-02-01      8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> United States Public Sector Coffee  2020-03-01     11</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Mexico        Enterprise    Coffee  2020-01-01     20</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Mexico        Enterprise    Coffee  2020-02-01     23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Mexico        Enterprise    Coffee  2020-03-01     27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Mexico        Enterprise    Tea     2020-01-01     50</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> Mexico        Enterprise    Tea     2020-02-01     55</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> Mexico        Enterprise    Tea     2020-03-01     60</span></span></code></pre>
<p>It would be hard to aggregate the above data in a traditional
hierarchy. The same products are found in different segments and
countries, also the same segments are found in multiple countries. Finn
will follow a similar modeling process as the one described for a
traditional hierarchy, but instead will create forecasts at the below
levels.</p>
<ul>
<li>Grand Total: model “Target” across the sum of “Country”, “Segment”,
and “Product”</li>
<li>Country: model “Target” across the sum of “Country”. Creating
forecasts for the grand total of “United States” and “Mexico”</li>
<li>Segment: model “Target” across the sum of “Segment”. Creating
forecasts for the grand total of “Enterprise” and “Public Sector”</li>
<li>Product: model “Target” across the sum of “Product”. Creating
forecasts for the grand total of “Coffee” and “Tea”.</li>
</ul>
</div>
<div class="section level3">
<h3 id="external-regressors">External Regressors<a class="anchor" aria-label="anchor" href="#external-regressors"></a>
</h3>
<p>The aggregation process is automatically calculated for each external
regressor, depending on how the regressor maps to the combo variables.
If a regressor is unique for each time series, then the standard
aggregation process is implemented (same as the process for the target
variable). If the regressor repeats the same values across all time
series, then only one global copy is retained and applied to all new
aggregated time series. If the regressor specifically maps to one or
more combo variables, then the relationship is respected while still
being able to aggregate to the total level. Aggregations of drivers are
always summed.</p>
<p>The only limitation is when an external regressor maps to the middle
of a standard hierarchy (not at the global level or bottom level), in
this case the regressor will be summed at the global level across the
hierarchy. This is due to limitations of aggregation naming in the hts
package used in finnts.</p>
<p>Explore the final results of the aggregations by seeing the end
result using <code><a href="../reference/get_prepped_data.html">get_prepped_data()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="spark-parallel-processing">Spark Parallel Processing<a class="anchor" aria-label="anchor" href="#spark-parallel-processing"></a>
</h3>
<p>There is also a small limitation when doing hierarchical forecasting
using spark as the parallel computing back-end. The hts package finnts
uses cannot handle spark data frames. So behind the scenes finnts has to
bring all of the data into memory on the spark cluster driver node in
order to create the hierarchies. Please keep that in mind. If you have a
lot of historical data that is greater than the RAM on the spark driver
node, please consider using a different VM size with more memory. The
same issue holds true when reconciling the hierarchical forecast, where
all of the forecasts across all time series for a specific model is
loaded into the same executor node to be reconciled. Because of these
limitations, we are now exploring other options outside of the hts
package, including the building of our own hierarchical forecasting
package. Stay tuned.</p>
</div>
<div class="section level3">
<h3 id="corner-cases-in-forecast-reconciliation">Corner Cases in Forecast Reconciliation<a class="anchor" aria-label="anchor" href="#corner-cases-in-forecast-reconciliation"></a>
</h3>
<p>Some forecasts can be widely off from the target value. This can
cause issues when finnts tries to use historical back testing residuals
as the initial weights in hts to reconcile the forecast at various
aggregations of your data down to the lowest level. To prevent
reconciliation issues, finnts will shrink these residuals to more
appropriate numbers that still convey they are considerably off from the
initial target values, but not astronomical. For example a residual
value of 1,000,000,000,000 compared to a target value of 100 might get
shrunk down to 900, since keeping the initial residual will throw the
weighted reconciliation process out of whack and cause issues. Most
forecasts in finnts will not have this problem, but if your data is very
noisy then this fix will help prevent any issues when trying to run
hierarchical forecasts in finnts.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.linkedin.com/in/michaeltokic/" class="external-link">Mike Tokic</a>, <a href="https://aadharshkannan.com/" class="external-link">Aadharsh Kannan</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
