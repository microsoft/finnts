<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel Processing • finnts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallel Processing">
<meta property="og:description" content="finnts">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-6X0DS5856B"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6X0DS5856B');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">finnts</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/finnts.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/back-testing-and-hyperparameter-tuning.html">Back Testing and Hyperparameter Tuning</a>
    </li>
    <li>
      <a href="../articles/best-model-selection.html">Best Model Selection</a>
    </li>
    <li>
      <a href="../articles/external-regressors.html">External Regressors</a>
    </li>
    <li>
      <a href="../articles/feature-engineering.html">Feature Engineering</a>
    </li>
    <li>
      <a href="../articles/hierarchical-forecasting.html">Hierarchical Forecasting</a>
    </li>
    <li>
      <a href="../articles/models-used-in-finnts.html">Models Used in finnts</a>
    </li>
    <li>
      <a href="../articles/parallel-processing.html">Parallel Processing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/microsoft/finnts/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="parallel-processing_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel Processing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/microsoft/finnts/blob/main/vignettes/parallel-processing.Rmd" class="external-link"><code>vignettes/parallel-processing.Rmd</code></a></small>
      <div class="hidden name"><code>parallel-processing.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="local-machine">Local Machine<a class="anchor" aria-label="anchor" href="#local-machine"></a>
</h2>
<p>When the “parallel_processing” input within “forecast_time_series” is set to “local_machine”, each time series (including training models on the entire data set) is ran in parallel on the users local machine. Each time series will run on a separate core of the machine. Hyperparameter tuning, model refitting, and model averaging will be ran sequentially, which cannot be done in parallel since a parallel process is already running on the machine for each time series. This works well for data that contains many time series where you might only want to run a few simpler models, and in scenarios where cloud computing is not available.</p>
<p>If “parallel_processing” is set to NULL and “run_model_parallel” is set to TRUE within the “forecast_time_series” function, then each time series is ran sequentially but the hyperparameter tuning, model refitting, and model averaging is ran in parallel. This works great for data that has a limited number of time series where you want to run a lot of back testing and build dozens of models within Finn.</p>
</div>
<div class="section level2">
<h2 id="within-azure-using-spark">Within Azure using Spark<a class="anchor" aria-label="anchor" href="#within-azure-using-spark"></a>
</h2>
<p>To leverage the full power of Finn, running within Azure is the best choice in building production ready forecasts that can easily scale. The most efficient way to run Finn is to set “parallel_processing” to “spark” within the “forecast_time_series” function. This will run each time series in parallel across a spark compute cluster.</p>
<p><a href="https://spark.rstudio.com/" class="external-link">Sparklyr</a> is a great R package that allows you to run R code across a spark cluster. A user simply has to connect to a spark cluster then run Finn. Below is an example on how you can run Finn using <a href="https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/sparklyr" class="external-link">spark on Azure Databricks</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load CRAN libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://microsoft.github.io/finnts/">finnts</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.rstudio.com/" class="external-link">sparklyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"qs"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traversc/qs" class="external-link">qs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># connect to spark cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sparklyr.log.console <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sparklyr.spark_apply.serializer <span class="op">=</span> <span class="st">"qs"</span><span class="op">)</span> <span class="co"># uses the qs package to improve data serialization before sending to spark cluster</span></span>
<span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">sparklyr</span><span class="fu">::</span><span class="fu">spark_connect</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"databricks"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># call Finn with spark parallel processing</span></span>
<span><span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">timetk</span><span class="fu">::</span><span class="va"><a href="https://business-science.github.io/timetk/reference/m4_monthly.html" class="external-link">m4_monthly</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">finn_output</span> <span class="op">&lt;-</span> <span class="fu">finnts</span><span class="fu">::</span><span class="fu"><a href="../reference/forecast_time_series.html">forecast_time_series</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">hist_data</span>,</span>
<span>  combo_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span>,</span>
<span>  target_variable <span class="op">=</span> <span class="st">"value"</span>,</span>
<span>  date_type <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>  forecast_horizon <span class="op">=</span> <span class="fl">3</span>, </span>
<span>  parallel_processing <span class="op">=</span> <span class="st">"spark"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The above example runs each time series on a separate core on a spark cluster. You can also submit multiple time series where each time series runs on a separate spark executor (VM) and then leverage all of the cores on that executor to run things like hyperparameter tuning or model refitting in parallel. This creates two levels of parallelization. One at the time series level, then another when doing things like hyperparameter tuning within a specific time series. To do that set the “run_model_parallel” argument to TRUE in the “forecast_time_series” function. Also make sure that you adjust the number of spark executor cores to 1, that ensures that only 1 time series runs on an executor at a time. Leverage the “spark.executor.cores” argument when configuring your spark connection. This can be done using <a href="https://spark.rstudio.com/guides/connections#:~:text=In%20sparklyr%2C%20Spark%20properties%20can%20be%20set%20by,customized%20as%20shown%20in%20the%20example%20code%20below." class="external-link">sparklyr</a> or within the cluster manager itself within the Azure resource. Use the “num_cores” argument in the “forecast_time_series” function to control how many cores should be used within an executor when running things like hyperparameter tuning.</p>
<p>Finn does not leverage spark data frames (yet!), so the input data to Finn still needs to be a standard data frame or tibble. The “forecast_time_series” function will be looking for a variable called “sc” to use when submitting tasks to the spark cluster, so make sure you use that as the variable name when connecting to spark.</p>
</div>
<div class="section level2">
<h2 id="within-azure-using-azure-batch">Within Azure using Azure Batch<a class="anchor" aria-label="anchor" href="#within-azure-using-azure-batch"></a>
</h2>
<p>Important Note: The Azure Batch R packages have been deprecated. Please leverage the newer Azure compute options with Finn (like spark).</p>
<p>The second most efficient way to run Finn in Azure is to set “parallel_processing” to “azure_batch” and set “run_model_parallel” to “TRUE” within the “forecast_time_series” function. This will run each time series in separate virtual machines (VM) in Azure Batch. Within each VM, hyperparameter tuning, modeling refitting, and model averaging are all done in parallel across the cores available on the machine.</p>
<p><a href="https://azure.microsoft.com/en-us/products/batch/#overview" class="external-link">Azure Batch</a> is a powerful resource from Microsoft Azure, that allows for easily salable parallel compute. Finn leverages the <a href="https://github.com/Azure/doAzureParallel" class="external-link">doAzureParallel</a> and rAzureBatch packages built by Microsoft to connect to Azure batch. Refer to their <a href="https://github.com/Azure/doAzureParallel" class="external-link">GitHub site</a> for more information about how it works under the hood and how to set up your own Azure Batch resource to use with Finn.</p>
<p>In order to have Finn live on CRAN, it cannot contain any package dependencies that live outside of CRAN. The doAzureParallel and rAzureBatch packages are only on GitHub, so they will have to be installed and called outside of Finn.</p>
<p>Reference the example below to understand how to connect to an Azure Batch compute cluster and submit forecasts to run in the cloud. Make sure to enter your specific Azure account information.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load CRAN libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://microsoft.github.io/finnts/">finnts</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load GitHub libraries</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"Azure/rAzureBatch"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"Azure/doAzureParallel"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rAzureBatch</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">doAzureParallel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create azure batch cluster info</span></span>
<span><span class="va">azure_batch_credentials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"sharedKey"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"batchAccount"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"name"</span> <span class="op">=</span> <span class="st">"&lt;insert resource name&gt;"</span>,</span>
<span>      <span class="st">"key"</span> <span class="op">=</span> <span class="st">"&lt;insert compute key&gt;"</span>,</span>
<span>      <span class="st">"url"</span> <span class="op">=</span> <span class="st">"&lt;insert resource URL&gt;"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">"storageAccount"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"name"</span> <span class="op">=</span> <span class="st">"&lt;insert resource name&gt;"</span>,</span>
<span>      <span class="st">"key"</span> <span class="op">=</span> <span class="st">"&lt;insert compute key&gt;"</span>,</span>
<span>      <span class="st">"endpointSuffix"</span> <span class="op">=</span> <span class="st">"core.windows.net"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"githubAuthenticationToken"</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>  <span class="st">"dockerAuthentication"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"username"</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                <span class="st">"password"</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                <span class="st">"registry"</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">azure_batch_cluster_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"name"</span> <span class="op">=</span> <span class="st">"&lt;insert compute cluster name&gt;"</span>,</span>
<span>  <span class="st">"vmSize"</span> <span class="op">=</span> <span class="st">"Standard_D5_v2"</span>, <span class="co"># solid VM size that has worked well in the past with Finn forecasts</span></span>
<span>  <span class="st">"maxTasksPerNode"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="co"># tells the cluster to only run one unique time series for each VM. That enables us to then run another layer of parallel processing within the VM</span></span>
<span>  <span class="st">"poolSize"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"dedicatedNodes"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"min"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      <span class="st">"max"</span> <span class="op">=</span> <span class="fl">200</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">"lowPriorityNodes"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"min"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      <span class="st">"max"</span> <span class="op">=</span> <span class="fl">100</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">"autoscaleFormula"</span> <span class="op">=</span> <span class="st">"QUEUE"</span> <span class="co"># automatically scales up VM's as more jobs get sent to the cluster. </span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"containerImage"</span> <span class="op">=</span> <span class="st">"mftokic/finn-azure-batch-dev"</span>, <span class="co"># docker image you can use that automatically downloads software needed for Finn to run in cloud</span></span>
<span>  <span class="st">"rPackages"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cran"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Rcpp'</span>, <span class="st">'modeltime'</span>, <span class="st">'modeltime.resample'</span>, <span class="st">'parsnip'</span>, <span class="st">'tune'</span>, <span class="st">'recipes'</span>, <span class="st">'rsample'</span>, <span class="st">'workflows'</span>, <span class="st">'dials'</span>, <span class="st">'lubridate'</span>, <span class="st">'rules'</span>, <span class="st">'Cubist'</span>, <span class="st">'earth'</span>, <span class="st">'kernlab'</span>, <span class="st">'doParallel'</span>, <span class="st">'dplyr'</span>, <span class="st">'tibble'</span>, <span class="st">'tidyr'</span>, <span class="st">'purrr'</span>, <span class="st">'stringr'</span>, <span class="st">'prophet'</span>, <span class="st">'glmnet'</span>, <span class="st">'gtools'</span><span class="op">)</span>, <span class="co"># finnts package dependencies</span></span>
<span>    <span class="st">"github"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="st">"bioconductor"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"commandLine"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create or connect to existing Azure Batch cluster</span></span>
<span><span class="fu">doAzureParallel</span><span class="fu">::</span><span class="fu">setCredentials</span><span class="op">(</span><span class="va">azure_batch_credentials</span><span class="op">)</span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu">doAzureParallel</span><span class="fu">::</span><span class="fu">makeCluster</span><span class="op">(</span><span class="va">azure_batch_cluster_config</span><span class="op">)</span></span>
<span><span class="fu">doAzureParallel</span><span class="fu">::</span><span class="fu">registerDoAzureParallel</span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># call Finn with Azure Batch parallel processing</span></span>
<span><span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">timetk</span><span class="fu">::</span><span class="va"><a href="https://business-science.github.io/timetk/reference/m4_monthly.html" class="external-link">m4_monthly</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">finn_output</span> <span class="op">&lt;-</span> <span class="fu">finnts</span><span class="fu">::</span><span class="fu"><a href="../reference/forecast_time_series.html">forecast_time_series</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">hist_data</span>,</span>
<span>  combo_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span>,</span>
<span>  target_variable <span class="op">=</span> <span class="st">"value"</span>,</span>
<span>  date_type <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>  forecast_horizon <span class="op">=</span> <span class="fl">3</span>, </span>
<span>  parallel_processing <span class="op">=</span> <span class="st">"azure_batch"</span>, </span>
<span>  run_name <span class="op">=</span> <span class="st">"azure_batch_forecast_test"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># optional code to delete compute cluster</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<p>The best part of Azure Batch is how it can easily scale to more compute as needed. In the above example, the lowest amount of VM’s running at any time will be 2, and can easily scale to 300 when needed. This allows you to pay for extra compute only when you need it, and allows for forecasts to run that much quicker. You can have separate Finn forecasts (different data sets or inputs) submitted to the same Azure Batch cluster to all run in parallel. How cool is that?!</p>
<p>To keep your Azure resource keys secure without hard coding them into a R script, check out the <a href="https://github.com/Azure/AzureKeyVault" class="external-link">Azure Key Vault</a> package to safely retrieve and leverage keys/secrets when using Finn.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.linkedin.com/in/michaeltokic/" class="external-link">Mike Tokic</a>, <a href="https://aadharshkannan.com/" class="external-link">Aadharsh Kannan</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
