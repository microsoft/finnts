<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel Processing • finnts</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallel Processing">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-6X0DS5856B"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6X0DS5856B');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">finnts</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0.9014</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/finnts.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ai-agent.html">AI Agent Capabilities</a>
    </li>
    <li>
      <a href="../articles/back-testing-and-hyperparameter-tuning.html">Back Testing and Hyperparameter Tuning</a>
    </li>
    <li>
      <a href="../articles/best-model-selection.html">Best Model Selection</a>
    </li>
    <li>
      <a href="../articles/external-regressors.html">External Regressors</a>
    </li>
    <li>
      <a href="../articles/feature-engineering.html">Feature Engineering</a>
    </li>
    <li>
      <a href="../articles/feature-selection.html">Feature Selection</a>
    </li>
    <li>
      <a href="../articles/forecast-components.html">Using Individual finnts Forecast Components</a>
    </li>
    <li>
      <a href="../articles/forecasting-genai.html">Forecasting with GenAI: TimeGPT in finnts</a>
    </li>
    <li>
      <a href="../articles/hierarchical-forecasting.html">Hierarchical Forecasting</a>
    </li>
    <li>
      <a href="../articles/models-used-in-finnts.html">Models Used in finnts</a>
    </li>
    <li>
      <a href="../articles/parallel-processing.html">Parallel Processing</a>
    </li>
    <li>
      <a href="../articles/tips-for-production.html">Tips for Production</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/microsoft/finnts/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel Processing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/microsoft/finnts/blob/main/vignettes/parallel-processing.Rmd" class="external-link"><code>vignettes/parallel-processing.Rmd</code></a></small>
      <div class="hidden name"><code>parallel-processing.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="local-machine">Local Machine<a class="anchor" aria-label="anchor" href="#local-machine"></a>
</h2>
<p>When <code>parallel_processing</code> within
<code><a href="../reference/forecast_time_series.html">forecast_time_series()</a></code> is set to “local_machine”, each time
series (including training models on the entire data set) is ran in
parallel on the users local machine. Each time series will run on a
separate core of the machine. Hyperparameter tuning, model refitting,
and model averaging will be ran sequentially, which cannot be done in
parallel since a parallel process is already running on the machine for
each time series. This works well for data that contains many time
series where you might only want to run a few simpler models, and in
scenarios where cloud computing is not available.</p>
<p>If <code>parallel_processing</code> is set to NULL and
<code>inner_parallel</code> is set to TRUE within
<code>forecast_time_series</code>, then each time series is ran
sequentially but the hyperparameter tuning, model refitting, and model
averaging is ran in parallel. This works great for data that has a
limited number of time series where you want to run a lot of back
testing and build dozens of models within Finn.</p>
</div>
<div class="section level2">
<h2 id="within-azure-using-spark">Within Azure using Spark<a class="anchor" aria-label="anchor" href="#within-azure-using-spark"></a>
</h2>
<p>To leverage the full power of Finn, running within Azure is the best
choice in building production ready forecasts that can easily scale. The
most efficient way to run Finn is to set
<code>parallel_processing</code> to “spark” within
<code><a href="../reference/forecast_time_series.html">forecast_time_series()</a></code>. This will run each time series in
parallel across a spark compute cluster.</p>
<p><a href="https://spark.posit.co/" class="external-link">Sparklyr</a> is a great R package
that allows you to run R code across a spark cluster. A user simply has
to connect to a spark cluster then run Finn. Below is an example on how
you can run Finn using <a href="https://learn.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/sparklyr" class="external-link">spark
on Azure Databricks</a>. Also check out the growing R support with using
<a href="https://learn.microsoft.com/en-us/azure/synapse-analytics/spark/apache-spark-r-language" class="external-link">spark
on Azure Synapse</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load CRAN libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://microsoft.github.io/finnts/">finnts</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.posit.co/" class="external-link">sparklyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"qs"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/qsbase/qs" class="external-link">qs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># connect to spark cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sparklyr.log.console <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sparklyr.spark_apply.serializer <span class="op">=</span> <span class="st">"qs"</span><span class="op">)</span> <span class="co"># uses the qs package to improve data serialization before sending to spark cluster</span></span>
<span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">sparklyr</span><span class="fu">::</span><span class="fu">spark_connect</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"databricks"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># call Finn with spark parallel processing</span></span>
<span><span class="va">hist_data</span> <span class="op">&lt;-</span> <span class="fu">timetk</span><span class="fu">::</span><span class="va"><a href="https://business-science.github.io/timetk/reference/m4_monthly.html" class="external-link">m4_monthly</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_sdf</span> <span class="op">&lt;-</span> <span class="fu">sparklyr</span><span class="fu">::</span><span class="fu">copy_to</span><span class="op">(</span><span class="va">sc</span>, <span class="va">hist_data</span>, <span class="st">"data_sdf"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_run_info.html">set_run_info</a></span><span class="op">(</span></span>
<span>  project_name <span class="op">=</span> <span class="st">"finn_fcst"</span>,</span>
<span>  run_name <span class="op">=</span> <span class="st">"spark_run_1"</span>,</span>
<span>  path <span class="op">=</span> <span class="st">"/dbfs/mnt/example/folder"</span> <span class="co"># important that you mount an ADLS path</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/forecast_time_series.html">forecast_time_series</a></span><span class="op">(</span></span>
<span>  run_info <span class="op">=</span> <span class="va">run_info</span>,</span>
<span>  input_data <span class="op">=</span> <span class="va">data_sdf</span>,</span>
<span>  combo_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span>,</span>
<span>  target_variable <span class="op">=</span> <span class="st">"value"</span>,</span>
<span>  date_type <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>  forecast_horizon <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  parallel_processing <span class="op">=</span> <span class="st">"spark"</span>,</span>
<span>  return_data <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># return the outputs as a spark data frame</span></span>
<span><span class="va">finn_output_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_forecast_data.html">get_forecast_data</a></span><span class="op">(</span></span>
<span>  run_info <span class="op">=</span> <span class="va">run_info</span>,</span>
<span>  return_type <span class="op">=</span> <span class="st">"sdf"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The above example runs each time series on a separate core on a spark
cluster. You can also submit multiple time series where each time series
runs on a separate spark executor (VM) and then leverage all of the
cores on that executor to run things like hyperparameter tuning or model
refitting in parallel. This creates two levels of parallelization. One
at the time series level, then another when doing things like
hyperparameter tuning within a specific time series. To do that set
<code>inner_parallel</code> to TRUE in
<code><a href="../reference/forecast_time_series.html">forecast_time_series()</a></code>. Also make sure that you adjust the
number of spark executor cores to 1, that ensures that only 1 time
series runs on an executor at a time. Leverage the
“spark.executor.cores” argument when configuring your spark connection.
This can be done using <a href="https://spark.posit.co/guides/connections#:~:text=In%20sparklyr%2C%20Spark%20properties%20can%20be%20set%20by,customized%20as%20shown%20in%20the%20example%20code%20below." class="external-link">sparklyr</a>
or within the cluster manager itself within the Azure resource. Use the
“num_cores” argument in the “forecast_time_series” function to control
how many cores should be used within an executor when running things
like hyperparameter tuning.</p>
<p><code><a href="../reference/forecast_time_series.html">forecast_time_series()</a></code> will be looking for a variable
called “sc” to use when submitting tasks to the spark cluster, so make
sure you use that as the variable name when connecting to spark. Also
it’s important that you mount your spark session to an Azure Data Lake
Storage (ADLS) account, and provide the mounted path to where you’d like
your Finn results to be written to within
<code><a href="../reference/set_run_info.html">set_run_info()</a></code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.linkedin.com/in/michaeltokic/" class="external-link">Mike Tokic</a>, <a href="https://aadharshkannan.com/" class="external-link">Aadharsh Kannan</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
